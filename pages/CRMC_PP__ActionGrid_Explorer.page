<apex:page sidebar="false" controller="CRMC_PP.DrillUpController" title="ActionGrid Explorer" docType="html-4.01-strict">
<!-- <apex:stylesheet value="{!URLFOR($Resource.kendoui, '/styles/kendo.common.min.css')}"/> -->
<!-- <apex:stylesheet value="{!URLFOR($Resource.kendoui, '/styles/kendo.silver.min.css')}"/> -->
<!-- <apex:includeScript value="https://code.jquery.com/jquery-1.11.0.min.js"/> -->
<!-- <apex:includeScript value="/soap/ajax/31.0/connection.js"/> -->
<!-- <apex:includeScript value="{!URLFOR($Resource.kendoui, '/js/kendo.all.min.js')}"/> -->

<style type="text/css">
    /* Hide extra scrollbar within splitter */
    .k-splitter #rightPane {
      overflow: hidden;
    }
    /* Match selected row color in object list to AG */
    div.k-state-selected { 
      color: #fff; 
      background-color: #1797c0;
    }
</style>

<script>


$(document).ready(function() {
crmc.require(['sfdc', 'ObjectList', 'GridBase', 'GridConstants'], function(sfdc, ObjectList, gridFactory, data){
  sforce.connection.sessionId = "{!JSENCODE($Api.Session_ID)}";

  var drillUpSettings = {
    remoteActions: {
      getDrillUpItemsForObject: '{!$RemoteAction.DrillUpController.getDrillUpItemsForObject}',
      getDrillDownItemsForObject: '{!$RemoteAction.DrillUpController.getDrillDownItemsForObject}',
    }
  };

  var pageURL = window.location.href;
  var gridid = "grid";

  var list = new ObjectList({
    elementId: "#ObjectList",
    permissionName: "explorer",
    delegate: {
      onSelectedChanged: function(text, metadata) {
        $('#explorerSplash').css('display', 'none');
        if (gridFactory.instances[gridid]) {
          // Navigating away from this object should save the sticky view
          gridFactory.instances[gridid].saveStickyView();
          gridFactory.instances[gridid].destroy();
        }
        // Create a new grid for the selected object
        var newGrid = gridFactory.create({
          pageInfo: {
            objectName: metadata.name,
          },
          isFullscreen:true,
          pageURL: pageURL,
          id: gridid,
          Partner_Server_URL_290: "{!$Api.Partner_Server_URL_290}"
        });
        // Set selected object in URL hash parameter
        window.location.hash = encodeURIComponent(metadata.name);
      }
    }
  });

  var showHelp = function(){
    $('#explorerDocumentation').attr('src', "https://support.getconga.com/Reference/ActionGrid_Explorer_Tab");
    $('#explorerSplash').css('display', 'block');
  }

  // If object name in hash parameter, set default selected object
  var selectedObject;
  // Also allow selected object to be passed as url parameter
  var urlParams = sfdc.parseAsObject();
  if (window.location.hash || (urlParams && urlParams['object'])) {
    var objectName = window.location.hash || urlParams['object'];
    objectName = decodeURIComponent(objectName);
    selectedObject = Object.first(list.kendoListView.element.children(), function(e) {
      var dataItem = list.kendoListView.dataItem(e);
      return dataItem && dataItem.name === objectName.replace("#", "");
    });
    if (selectedObject) {
      list.kendoListView.select(selectedObject);
    }
    else {
      showHelp();
    }

   
  } 
  else {
    showHelp();
  }

  // Resize to fill available space
  var mainPane = $("#mainPane");
  var objList = $("#ObjectList > .k-block");

  var resizeElements = function() {
    var parentOffset = mainPane.offset();
    parentOffset = parentOffset || {top:0}; // If parent element not visible...
    // Determine if header is displayed and not embedded on page layout
    var showHeader = $("#AppBodyHeader").length > 0;
    // Size to fit either related list viewport or VF page space
    var h = showHeader ? $(window).height() - data.SFDC_HEADER_PX : $(window).height() - parentOffset.top - 10; 
    mainPane.height(h);
    objList.css('max-height', (h - 45) + 'px');
    objList.height(h + 'px');
  };

  $(window).on('resize', resizeElements);

  resizeElements();

  $("#mainPane").kendoSplitter({
    orientation: "horizontal",
    panes: [
      { collapsible: true, size: "200px" },
      { collapsible: false }
    ]
  });
});

});
</script>

<div id="mainPane" style="width:100%; border:0;">
<div id="ObjectList" style="padding:2px; background-color: none;" class="k-content" />
<div id="rightPane">
  <div id="explorerSplash" style="float:left;width:calc(100% - 5px);height:100%;display:none;">
      <iframe id="explorerDocumentation" style="height:100%; margin-left:5px;" width="100%" height="100%"/>
  </div>
  <c:Grid IncludeOnly="true" id="grid" />
</div>
</div>

</apex:page>